FROM golang:1.25.4-trixie AS builder
WORKDIR /app/

RUN apt-get update && apt-get install -y libvpx-dev pkg-config

#dlv
RUN go install github.com/go-delve/delve/cmd/dlv@v1.25

COPY . .

RUN go mod download
RUN CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build -gcflags="-N -l" -a -o ./bin/web_rtc/signaling ./cmd/web_rtc_server/signaling.go


FROM debian:trixie-slim
RUN apt update && apt install -y libvpx9 && rm -rf /var/lib/apt/lists/*

WORKDIR /app/
COPY --from=builder /app/bin/web_rtc/signaling ./bin/web_rtc/signaling
COPY --from=builder /go/bin/dlv /

EXPOSE 7070 2345

CMD ["./bin/web_rtc/signaling"]